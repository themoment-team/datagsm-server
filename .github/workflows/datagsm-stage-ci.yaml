name: DataGSM stage CI Workflow

on:
  pull_request:
    branches:
      - 'develop'
  push:
    branches:
      - 'develop'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-title:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Validate PR Title
        uses: actions/github-script@v8
        with:
          script: |
            const title = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;
            const allowedScopes = [
              'global', 'account', 'auth', 'client', 'club',
              'neis', 'oauth', 'project', 'student',
              'web', 'oauth', 'openapi', 'ci/cd'
            ];

            const versionPattern = /^v\d{8}\.\d+$/;
            if (versionPattern.test(title)) {
              return;
            }

            const titlePattern = /^\[([^\]]+)\]\s+(.+)$/;
            const match = title.match(titlePattern);
            if (!match) {
              core.setFailed('Invalid title format. Use [scope] title or vYYYYMMDD.n format');
              return;
            }

            const scopesPart = match[1];
            const titlePart = match[2];

            if (titlePart.includes(':')) {
              core.setFailed('Colon (:) is not allowed in the title');
              return;
            }
            const scopes = scopesPart.split(',').map(s => s.trim());
            const invalidScopes = scopes.filter(scope => !allowedScopes.includes(scope));
            if (invalidScopes.length > 0) {
              core.setFailed(`Invalid scope(s): ${invalidScopes.join(', ')}`);
              return;
            }

  setup-pr-metadata:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Setup PR Metadata
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          gh pr edit $PR_NUMBER --repo ${{ github.repository }} --add-label "waiting for review:검토 대기"
          gh pr edit $PR_NUMBER --repo ${{ github.repository }} --add-assignee "$PR_AUTHOR"
          ALL_REVIEWERS="wwwcomcomcomcom,ZaMan-O,hongjm0912,snowykte0426"
          REVIEWERS=$(echo "$ALL_REVIEWERS" | tr ',' '\n' | grep -v "^${PR_AUTHOR}$" | tr '\n' ',' | sed 's/,$//')
          if [ -n "$REVIEWERS" ]; then
            gh pr edit $PR_NUMBER --repo ${{ github.repository }} --add-reviewer "$REVIEWERS"
          fi

  build-and-test:
    runs-on: ubuntu-latest
    needs: [validate-title]
    if: always() && (needs.validate-title.result == 'success' || needs.validate-title.result == 'skipped')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false
          gradle-home-cache-cleanup: true

      - name: Test with Gradle
        run: ./gradlew build --parallel --build-cache

  notify:
    runs-on: ubuntu-latest
    needs: [validate-title, setup-pr-metadata, build-and-test]
    if: always()

    steps:
      - name: Determine Status
        id: status
        run: |
          if [[ "${{ needs.validate-title.result }}" == "failure" ]] || \
             [[ "${{ needs.build-and-test.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=0xFF4C4C" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=0x4CAF50" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
            echo "color=0xFFA500" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_INFORMATION_ALERT_CHANNEL_WEBHOOK }}
          status: ${{ steps.status.outputs.status }}
          color: ${{ steps.status.outputs.color }}
          title: "DataGSM Stage CI"
          description: |
            **Validate Title:** ${{ needs.validate-title.result }}
            **Setup Metadata:** ${{ needs.setup-pr-metadata.result }}
            **Build & Test:** ${{ needs.build-and-test.result }}
